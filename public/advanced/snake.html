<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>MultiPlayer Snake</title>
  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.0/css/bootstrap.min.css" integrity="sha384-9aIt2nRpC12Uk9gS9baDl411NQApFmC26EwAOH8WgZl5MYYxFfc+NcPb1dKGj7Sk" crossorigin="anonymous">

<style>
#gameScreen {
  display: none;
}
</style>
</head>
<body>
  <section class="vh-100">
    <div class="container h-100">

      <div id="initialScreen" class="h-100">
        <div class="d-flex flex-column align-items-center justify-content-center h-100">
            <h1>Multiplayer Snake</h1>
            <button
              type="submit"
              class="btn btn-success"
              id="newGameButton"
            >
              Create New Game
            </button>
            <div>OR</div>
            <div class="form-group">
              <input type="text" placeholder="Enter Game Code" id="gameCodeInput"/>
            </div>
            <button
              type="submit"
              class="btn btn-success"
              id="joinGameButton"
            >
              Join Game
            </button>
        </div>
      </div>

      <div id="gameScreen" class="h-100">
        <div class="d-flex flex-column align-items-center justify-content-center h-100">

          <h1>Your game code is: <span id="gameCodeDisplay"></span></h1>

          <canvas id="canvas"></canvas>
        </div>
      </div>

    </div>
  </section>

  <script type="text/javascript" src="/magx"></script>
  <script>
    const BG_COLOUR = '#231f20';
    const SNAKE_COLOUR = '#c2c2c2';
    const FOOD_COLOUR = '#e66916';

    let state = {}
    let room = null

    let gameActive = false;

    const gameScreen = document.getElementById('gameScreen');
    const initialScreen = document.getElementById('initialScreen');
    const newGameBtn = document.getElementById('newGameButton');
    const joinGameBtn = document.getElementById('joinGameButton');
    const gameCodeInput = document.getElementById('gameCodeInput');
    const gameCodeDisplay = document.getElementById('gameCodeDisplay');

    function paintPlayer(id, size, color) {
      const snake = state.players[id].snake;

      ctx.fillStyle = color;
      for (let cell of snake) {
        ctx.fillRect(cell.x * size, cell.y * size, size, size);
      }
    }

    function paintGame() {
      ctx.fillStyle = BG_COLOUR;
      ctx.fillRect(0, 0, canvas.width, canvas.height);

      const gridsize = state.gridSize;
      const size = canvas.width / gridsize;

      for (const f of state.food) {
        ctx.fillStyle = FOOD_COLOUR;
        ctx.fillRect(f.x * size, f.y * size, size, size);
      }

      Object.keys(state.players).forEach(id => {
        const color = id === client.auth.id ? SNAKE_COLOUR : "red"
        paintPlayer(id, size, color);
      })
    }

    function gameOver(looser) {
      if (!gameActive || !looser) {
        return;
      }
      gameActive = false;

      if (looser === client.auth.id) {
        alert('You Lose :(');
      } else {
        alert('You Win!');
      }
    }

    const { host, port, protocol } = window.document.location
    const serializer = MagX.SchemaSerializer
    const client = new MagX.Client({ address: host.replace(/:.*/, ''), port, secure: protocol === "https:", serializer })

    const initRoom = () => {
      console.log("joined room")
      gameCodeDisplay.innerText = room.id;
      
      // add state snapshot handler
      room.onSnapshot((snapshot) => {
        state = snapshot
        paintGame()
      })

      room.onPatch(() => {
        requestAnimationFrame(() => paintGame())
      })

      // add change handlers
      room.onChange("add", "food/:index", (patch, { index }) => state.food.push(patch.value))
      room.onChange("remove", "food/:index", (patch, { index }) => state.food.splice(index, 1))

      room.onChange("add", "players/:id", (patch, { id }) => state.players[id] = patch.value)
      room.onChange("remove", "players/:id", (patch, { id }) => delete state.players[id])

      room.onChange("add", "players/:id/snake/:index", (patch, { id, index }) => state.players[id].snake[index] = patch.value)
      room.onChange("remove", "players/:id/snake/:index", (patch, { id, index }) => state.players[id].snake.splice(index, 1))

      room.onChange("replace", "looser", (patch) => gameOver(patch.value))

      initialScreen.style.display = "none";
      gameScreen.style.display = "block";

      canvas = document.getElementById('canvas');
      ctx = canvas.getContext('2d');

      canvas.width = canvas.height = 600;

      ctx.fillStyle = BG_COLOUR;
      ctx.fillRect(0, 0, canvas.width, canvas.height);

      window.addEventListener("keydown", ({ which }) => {
        switch (which) {
          case 37: return room.send("keypress", 0) // LEFT
          case 38: return room.send("keypress", 1) // Up
          case 39: return room.send("keypress", 2) // RIGHT
          case 40: return room.send("keypress", 3) // DOWN
        }
      })
      gameActive = true;
    }

    const newGame = async () => {
      room = await client.createRoom("snake") // create new room
      initRoom()
    }

    const joinGame = async() => {
      const roomId = gameCodeInput.value;
      room = await client.joinRoom(roomId) // join existing room
      if (!room) { return }
      initRoom()
    }

    newGameBtn.addEventListener('click', newGame);
    joinGameBtn.addEventListener('click', joinGame);

    try {
      client.authenticate()
    } catch (error) {
      console.log(error)
    }
  </script>
</body>
</html>